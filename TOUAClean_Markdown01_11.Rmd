---
title: "[M1 MIASHS - TER] Visualisation du dataset TOUA"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

La première étape de notre projet de TER consiste à analyser trois jeux de données sur des arabidopsis pour comprendre comment des conditions de fort CO2 impactent la quantité de nutriments qu'elles produisent. Vous trouverez ci-après l'analyse du premier dataset dont nous disposons qui s'appelle TOUA.

## Données brutes 

Voici les données fournies par nos commanditaires. Nous allons pouvoir leur appliquer plusieurs traitement afin de nous familiariser avec et de visualiser les dynamiques entre les différentes variables observées.


```{r call1, message=FALSE, warning=FALSE, echo=FALSE}
library(tidyr)
library(dplyr)
library(ggpubr)

```
```{r}
toua <- read.csv2("TOUA_phenotypes.csv")
head(toua)
```


### Rajout de la colonne de Changement pour le Carbonne et le cuivre

Nous avons commencé par rajouter deux variables de variation qui pouvaient être facilement calculées : 

```{r message=FALSE, warning=FALSE}
toua$C_change <- round(((toua$C_eCo2-toua$C_aCo2)/toua$C_aCo2)*100, digits = 2)
toua$Cu_change <- round(((toua$Cu_eCo2-toua$Cu_aCo2)/toua$Cu_aCo2)*100, digits = 2)
```

## Identification des outliers

```{r fig.height=4, fig.width=4,message=FALSE, warning=FALSE, echo=FALSE}
attach(toua)
plot(Fe_aCo2, Fe_eCo2, main="Scatterplot Fe",
     xlab="Fe_aCo2", ylab="Fe_eCo2", pch=19)
```

```{r fig.height=4, fig.width=4, message=FALSE, warning=FALSE, echo=FALSE}
attach(toua)
plot(Zn_aCo2, Zn_eCo2, main="Scatterplot Zinc",
     xlab="Zn_aCo2", ylab="Zn_eCo2") 
```

Comme le montrent ces deux Scatter plots,certaines valeurs pour certains éléments sont très singulières, et après discussion avec nos encadrants nous en avons conclu qu'il s'agit d'erreurs de mesures qui ne peuvent pas exister en réalité. Nous allons donc les supprimer.

## Suppression des outliers 
 Nous allons maintenant supprimer les outliers en choisissant d'enlever les lignes contenant des valeurs plus de trois fois plus grandes que la médiane. Nous avons choisi la médiane et non l'écart type car les valeurs des outliers ont moins d'influence sur elle.
 
```{r message=FALSE, warning=FALSE}
toua_no_out <- toua
k= 3
for (i in 2:17) {
  binf <- median(toua[,i]) - k* mad(toua[,i])
  bsup <- median(toua[,i]) + k* mad(toua[,i])
  outlier_idx <- which(toua_no_out[,i] < binf | toua_no_out[,i] > bsup)
    if (length(outlier_idx) == 0) {
      toua_no_out = toua_no_out
    }
    else{
      toua_no_out = toua_no_out[-c(outlier_idx),]
      }
  #print(outlier_idx)
  }
  
```

### Calcul des colonnes de variation sans les outliers

Comme nous avons supprimé les lignes contenant des outliers, ils nous faut recalculer les colonnes de variation pour chaque élément, ce qui nous donne ce nouveau DataFrame : 

```{r message=FALSE, warning=FALSE, echo=FALSE}
# Suppression des anciennes colonnes
toua_no_out_no_ch <- subset (toua_no_out, select = -c(Fe_change:Cu_change))
toua_no_out <- subset(toua_no_out_no_ch, select = -c(N_change))

# Ajout des nouvelles colonnes

toua_no_out$N_change <- round(((toua_no_out$N_eCo2-toua_no_out$N_aCo2)/toua_no_out$N_aCo2)*100, digits = 2)

toua_no_out$Fe_change <- round(((toua_no_out$Fe_eCo2-toua_no_out$Fe_aCo2)/toua_no_out$Fe_aCo2)*100, digits = 2)

toua_no_out$Mg_change <- round(((toua_no_out$Mg_eCo2-toua_no_out$Mg_aCo2)/toua_no_out$Mg_aCo2)*100, digits = 2)

toua_no_out$Mn_change <- round(((toua_no_out$Mn_eCo2-toua_no_out$Mn_aCo2)/toua_no_out$Mn_aCo2)*100, digits = 2)

toua_no_out$Na_change <- round(((toua_no_out$Na_eCo2-toua_no_out$Na_aCo2)/toua_no_out$Na_aCo2)*100, digits = 2)

toua_no_out$Zn_change <- round(((toua_no_out$Zn_eCo2-toua_no_out$Zn_aCo2)/toua_no_out$Zn_aCo2)*100, digits = 2)

toua_no_out$C_change <- round(((toua_no_out$C_eCo2-toua_no_out$C_aCo2)/toua_no_out$C_aCo2)*100, digits = 2)

toua_no_out$Cu_change <- round(((toua_no_out$Cu_eCo2-toua_no_out$Cu_aCo2)/toua_no_out$Cu_aCo2)*100, digits = 2)

head(toua_no_out)

toua_ch <- select(toua_no_out,"genotype"|contains("change"))

```

### Passage en format long avec gather 

Pour pouvoir réaliser certaines visualisations, nous avons besoin  de mettre nos données au format long, ce qui nous donne le DataFrame suivant :

```{r message=FALSE, warning=FALSE, echo= FALSE}
toua_chl <- gather(data = toua_ch, key = "element", value = "valeur", 2:9)
head(toua_chl)
```

## Première Visualisation : Variation moyenne des mesures entre le aCO2 et le eCO2

Nous avons ici voulu reproduire une visualisation qui avait été faite dans le cas du riz pour montrer la variation de chaque élément quand la plante est en condition de fort CO2 et quand elle est en condition de CO2 ambiant.

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(hrbrthemes)
library(viridis)
```

```{r}
ggplot(toua_chl, aes(element, valeur, fill = element))+
  stat_summary(fun = mean, geom = "bar") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2)+
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", size = 1) +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  theme_bw()
```

Observations : 

1) On n'observe pas vraiment de hausse des taux de Carbonne mesurés (contrairement à ce qui a été vu chez le riz par exemple) mais cela s'explique par le fait que la mesure est rapportée au poids de la plante. Ce résultat est donc plutôt normal.
2) On observe une forte diminution du zinc et du fer, deux nutriments essentiels dans l'alimentation, ainsi qu'une grande diminution de l'azote. On observe des diminutions moins marquées mais néanmoins notables pour le magnésium et le cuivre. Enfin, on peut voir une augmentation du manganèse assez importante pour être soulignée.

##Scatter Plots

Afin de visualiser d'une autre façon si il y a une perte de certains éléments quand la plante est en condition de fort CO2, nous avons créé des scatter plots.

### Scatter Plots des éléments e/a

```{r fig.height=4, fig.width=4,}
i = 2
while (i < 17) {
plot(toua_no_out[,i+1], toua_no_out[,i], xlab = names(toua_no_out[i+1]), ylab = names(toua_no_out[i]),asp=1) 
abline(0,1, col = "blue")
i = i + 2}


```


La ligne bleue représente la droite d'ordonnée à l'origine 0 et de coefficient directeur 1. Nous pouvons déjà constater visuellement que le Fer, le Magnénium, le zinc et l'azote ont l'air de diminuer en condition de CO2 élevé.
Nous vérifierons plus tard avec plusieurs tests si nos intuitions sont correctes.

## Distribution des données : Histogrammes et Violin plots

### Violin plots

```{r fig.height=10, fig.width=10, message=FALSE, warning=FALSE, echo = FALSE}
library(reshape2)
library(ggplot2)

#on met au format long
toua_no_out_no_ch = toua_no_out
toua_no_out_no_ch = subset (toua_no_out_no_ch, select = -c(N_change:eCN_aCN))
toua_no_out_no_ch = subset (toua_no_out_no_ch, select = -c(aCN_ratio:Cu_change))


toua_long = melt(toua_no_out_no_ch)
#print(head(toua_long))

ggplot(data= toua_long, aes(x=variable, y=value))+
  geom_violin(aes(fill=variable, draw_quantiles = c(0.5)))+
  geom_jitter(alpha=0.2)+
  facet_wrap(~variable,scales ="free")+
  ggtitle("Violin plots de chaque élément")+
  stat_compare_means(method = t.test)

```


### Histogrammes

```{r fig.height=10, fig.width=10, message=FALSE, warning=FALSE, echo=FALSE}

#print(shapiro.test(toua_no_out[,i]))

ggplot(data= toua_long, aes(x=value))+
  geom_histogram()+
  facet_wrap(~variable,scales ="free")+
  ggtitle("histogramme de chaque élément")

```

Après ces deux visualisations nous pouvons remarquer que les distributions ont l'air pour la plupart normales mais que des doutes quand à leur normalité persistent.


## Tests de normalité : Test de Shapiro

Dans le but de choisir des tests sur la moyenne et sur la variance adaptés à nos données, nous avons commencé par réaliser un test de normalité, ici le test de Shapiro.

Voici les p-values pour la distribution de chaque élément : 

```{r echo = FALSE}
i = 2
while (i < 17) {
  print(paste("Test de Shapiro entre les données", names(toua_no_out[i]), "et", names(toua_no_out[i+1])))
  print(shapiro.test(toua_no_out[,i])$p.value)
  i = i + 2
}
```

Ici, nous remarquons que les éléments dont la distribution ne suit pas une loi normale après avoir enlevé les outliers sont : Mg, Mn, Zn et N

### Test de significativité sur les moyennes : Wilcoxon
Ici on a choisi un test de Wilcoxon (car on ne respecte pas les pré-requis pour un test paramétrique pour toutes nos variables) pour des valeurs paired, car la mesure en Co2 ambiant et élevé sont réalisées sur les mêmes génotypes. Vous trouverez ci dessous des violin plots deux à deux et la p-value de chaque paire avec le test de Wilcoxon.

```{r fig.height=15, fig.width=15, message=FALSE, warning=FALSE, echo = FALSE}
library(ggplot2)
library(RColorBrewer)

toua_long = melt(toua_no_out_no_ch)
toua_long$element = stringr::str_split_fixed(toua_long$variable, "_",2)[,1]
toua_long$Co2 = stringr::str_split_fixed(toua_long$variable, "_",2)[,2]

nb.cols <- 16
mycolors <- colorRampPalette(brewer.pal(8, "Paired"))(nb.cols)

ggplot(data = toua_long, aes(x = Co2, y = value)) +
  geom_violin(aes(fill = variable), draw_quantiles = c(0.5)) +
  facet_wrap( ~ element, scales = "free") +
  scale_fill_manual(values = mycolors) +
  stat_compare_means(paired = TRUE, method = "wilcox")
```

Ce test nous apprend que pour l'instant, tous les éléments sont significativement différents sauf le Na et le C.

### Autre visualisation du résultat du test de Wilcoxon

```{r fig.height=4, fig.width=4,}
i=2
while (i < 17) {
  plot_paired <- ggpaired(toua_no_out, cond1 = names(toua_no_out[i+1]) , cond2 = names(toua_no_out[i]),
           line.color = "dark gray", line.size = 0.6, color = "condition",
           width = 0.7, linetype = "dotted" ,
           palette = "aas")+
    stat_compare_means(paired = TRUE)
  print(plot_paired)
  i = i+2
}
```

### Test de significativité sur les moyennes pour les répartitions normales : Student

```{r echo = FALSE}
i = 2
while (i < 17) {
  print(paste("Test de Student entre les données", names(toua_no_out[i]), "et", names(toua_no_out[i+1])))
  print(paste("p-value = ",t.test(toua_no_out[,i+1], toua_no_out[,i], paired = TRUE)$p.value))
  i = i + 2
}
```

### Test de significativité sur les variances pour les répartitions non normales : Fligner_Killeen's

```{r echo = FALSE}

toua_no_out_no_Mg <- subset (toua_no_out, select = -c(Mg_eCo2,Mg_aCo2))
i = 2
while (i < 15) {
  print(paste("Test de Fligner-Kileen's entre les données", names(toua_no_out[i]), "et", names(toua_no_out[i+1])))
  print(paste("p-value = ",fligner.test(toua_no_out_no_Mg[,i+1], toua_no_out_no_Mg[,i], paired = TRUE)$p.value))
  i = i + 2
}
```

Ce test nous apprend que toutes les variables sont de variances significativement différentes entre le fort CO2 et le CO2 ambiant